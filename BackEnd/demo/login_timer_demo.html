<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login with Real-time Timer Demo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 400px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .timer { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 15px 0; text-align: center; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 4px; margin: 15px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 15px 0; }
        .countdown { font-size: 24px; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <h2>FoodFusion Login Demo</h2>
    
    <form id="loginForm">
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
        </div>
        
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
        </div>
        
        <button type="submit" id="loginBtn">Login</button>
    </form>
    
    <div id="message"></div>
    <div id="timer" class="timer" style="display: none;">
        <div>Account temporarily locked</div>
        <div class="countdown" id="countdown">00:00</div>
        <div>Please wait before trying again</div>
    </div>

    <script>
        const API_BASE = '../api';
        let timerInterval;
        let blockCheckInterval;

        // Check block status on page load
        checkBlockStatus();

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/login.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Login successful! Welcome back!', 'success');
                    clearTimer();
                } else {
                    if (data.data && data.data.blocked) {
                        startTimer(data.data.remaining_seconds);
                        showMessage(data.error, 'error');
                    } else {
                        showMessage(data.error || 'Login failed', 'error');
                    }
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        });

        async function checkBlockStatus() {
            try {
                const response = await fetch(`${API_BASE}/check_block_status.php`);
                const data = await response.json();
                
                if (data.success && data.data.blocked) {
                    startTimer(data.data.remaining_seconds);
                } else {
                    clearTimer();
                }
            } catch (error) {
                console.error('Error checking block status:', error);
            }
        }

        function startTimer(seconds) {
            clearTimer();
            
            const timerDiv = document.getElementById('timer');
            const countdownDiv = document.getElementById('countdown');
            const loginBtn = document.getElementById('loginBtn');
            
            timerDiv.style.display = 'block';
            loginBtn.disabled = true;
            
            let remainingSeconds = seconds;
            
            function updateTimer() {
                if (remainingSeconds <= 0) {
                    clearTimer();
                    checkBlockStatus(); // Recheck status when timer ends
                    return;
                }
                
                const minutes = Math.floor(remainingSeconds / 60);
                const secs = remainingSeconds % 60;
                countdownDiv.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                remainingSeconds--;
            }
            
            updateTimer(); // Initial call
            timerInterval = setInterval(updateTimer, 1000);
            
            // Also check server status periodically
            blockCheckInterval = setInterval(checkBlockStatus, 10000); // Check every 10 seconds
        }

        function clearTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            if (blockCheckInterval) {
                clearInterval(blockCheckInterval);
                blockCheckInterval = null;
            }
            
            document.getElementById('timer').style.display = 'none';
            document.getElementById('loginBtn').disabled = false;
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type;
            
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 5000);
        }

        // Check block status periodically when page is active
        setInterval(() => {
            if (!timerInterval) {
                checkBlockStatus();
            }
        }, 30000); // Check every 30 seconds when not blocked
    </script>
</body>
</html>